import{c as e,w as t,h as a,r as s,j as l,i as o,o as r,a as i,f as d,e as n,t as c,g as u,k as h,l as f,F as g,m as D,b as m}from"./index-BMZ5TM4R.js";import{_,g as p}from"./_plugin-vue_export-helper.iOdWERSQ.js";const y=_({data:()=>({schedule:null,isLoading:!0,error:"",selectedDate:"",formattedDate:""}),onLoad(){const e=new Date;this.selectedDate=this.formatDate(e),this.formattedDate=this.formatDisplayDate(e),this.loadSchedule()},methods:{formatDate:e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,formatYMD(e){try{if(!e||"2000-12-31"===e||e.startsWith("2000-"))return this.formatDisplayDate(this.selectedDate);const t=e.split("-");return 3!==t.length?this.formatDisplayDate(this.selectedDate):`${t[0]}年${parseInt(t[1])}月${parseInt(t[2])}日`}catch(t){return console.error("日期格式化错误:",t),this.formatDisplayDate(this.selectedDate)}},formatDisplayDate(e){"string"==typeof e&&(e=new Date(e)),e.getFullYear();return`${e.getMonth()+1}月${e.getDate()}日 ${["周日","周一","周二","周三","周四","周五","周六"][e.getDay()]}`},onDateChange(e){this.selectedDate=e.detail.value,this.formattedDate=this.formatDisplayDate(new Date(e.detail.value))},async loadSchedule(){this.isLoading=!0,this.error="";const e=setTimeout((()=>{this.isLoading&&(this.isLoading=!1,this.error="获取课表超时，请重试",console.error("课表安全超时触发"))}),2e4);try{const t=l("username"),o=l("password");if(!t||!o)return clearTimeout(e),this.isLoading=!1,this.error="登录信息已失效，请重新登录",void setTimeout((()=>{s({url:"/pages/login/index"})}),1500);console.log("开始获取课表..."),console.log("请求日期:",this.selectedDate);const r=await p(t,o,this.selectedDate);console.log("课表结果:",r),clearTimeout(e),r&&r.success?(this.schedule=this.processScheduleData(r.data),this.isLoading=!1):(this.isLoading=!1,this.error=r&&r.error||"获取课表失败",r&&r.error&&(r.error.includes("登录")||r.error.includes("会话"))&&(a("isLoggedIn"),a("password"),setTimeout((()=>{s({url:"/pages/login/index"})}),1500)))}catch(t){clearTimeout(e),console.error("获取课表出错:",t),this.isLoading=!1,this.error=t.message||"获取课表失败，请重试"}},processScheduleData(e){return e&&e.length?(console.log("处理课表数据:",e),e.map((e=>(e.date&&"2000-12-31"!==e.date&&!e.date.startsWith("2000-")&&this.isValidDate(e.date)||(console.log(`替换无效日期 ${e.date||"无"} -> ${this.selectedDate}`),e.date=this.selectedDate),e)))):[]},isValidDate(e){if(!e)return!1;if(!e.match(/^\d{4}-\d{2}-\d{2}$/))return!1;const t=new Date(e),a=t.getTime();if(!a&&0!==a)return!1;const s=t.getFullYear(),l=(new Date).getFullYear();return!(s<l-1||s>l+1)&&t.toISOString().slice(0,10)===e},handleLogout(){a("isLoggedIn"),a("username"),a("password"),s({url:"/pages/login/index"})}}},[["render",function(a,s,l,_,p,y){const k=d,L=u,S=o,$=h;return r(),e(S,{class:"schedule-container"},{default:t((()=>[i(S,{class:"header"},{default:t((()=>[i(k,{class:"title"},{default:t((()=>[n("课表查询 - "+c(p.formattedDate),1)])),_:1}),i(L,{class:"logout-btn",onClick:y.handleLogout},{default:t((()=>[n("退出登录")])),_:1},8,["onClick"])])),_:1}),i(S,{class:"date-selector"},{default:t((()=>[i(S,{class:"date-label"},{default:t((()=>[n("选择日期:")])),_:1}),i($,{mode:"date",value:p.selectedDate,onChange:y.onDateChange},{default:t((()=>[i(S,{class:"date-value"},{default:t((()=>[n(c(p.selectedDate||"今天"),1)])),_:1})])),_:1},8,["value","onChange"]),i(L,{class:"query-btn",onClick:y.loadSchedule},{default:t((()=>[n("查询")])),_:1},8,["onClick"])])),_:1}),i(S,{class:"content"},{default:t((()=>[p.isLoading?(r(),e(S,{key:0,class:"loading"},{default:t((()=>[i(k,null,{default:t((()=>[n("加载中...")])),_:1})])),_:1})):p.error?(r(),e(S,{key:1,class:"error"},{default:t((()=>[i(k,null,{default:t((()=>[n(c(p.error),1)])),_:1}),i(L,{class:"retry-btn",onClick:y.loadSchedule},{default:t((()=>[n("重试")])),_:1},8,["onClick"])])),_:1})):p.schedule&&0!==p.schedule.length?(r(),e(S,{key:3,class:"schedule-list"},{default:t((()=>[(r(!0),f(g,null,D(p.schedule,((a,s)=>(r(),e(S,{key:s,class:"course-card"},{default:t((()=>[i(S,{class:"course-name"},{default:t((()=>[n(c(a.name),1)])),_:2},1024),i(S,{class:"course-info"},{default:t((()=>[i(k,{class:"info-item"},{default:t((()=>[i(k,{class:"label"},{default:t((()=>[n("时间：")])),_:1}),n(" "+c(a.time)+" ",1),a.startTime?(r(),e(k,{key:0,class:"time-details"},{default:t((()=>[n(" ("+c(a.startTime)+" - "+c(a.endTime)+") ",1)])),_:2},1024)):m("",!0)])),_:2},1024),i(k,{class:"info-item"},{default:t((()=>[i(k,{class:"label"},{default:t((()=>[n("地点：")])),_:1}),n(" "+c(a.location),1)])),_:2},1024),a.teacher?(r(),e(k,{key:0,class:"info-item"},{default:t((()=>[i(k,{class:"label"},{default:t((()=>[n("教师：")])),_:1}),n(" "+c(a.teacher),1)])),_:2},1024)):m("",!0),i(k,{class:"info-item course-date"},{default:t((()=>[i(k,{class:"label"},{default:t((()=>[n("日期：")])),_:1}),n(" "+c(y.formatYMD(a.date)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(r(),e(S,{key:2,class:"no-class"},{default:t((()=>[i(k,null,{default:t((()=>[n("当天没有课程安排")])),_:1})])),_:1}))])),_:1})])),_:1})}],["__scopeId","data-v-af53a3af"]]);export{y as default};
